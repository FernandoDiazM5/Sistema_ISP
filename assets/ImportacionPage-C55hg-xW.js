import{c as me,r as f,j as e,g as xe,B as pe,U as ue,h as J,W as Q,i as X,L as be,a as p,T as he,k as ge,R as K,l as fe}from"./index-z5gwiLCk.js";import{read as je,utils as y,writeFile as U}from"./xlsx-CNerDvZX.js";import{F as z,D as $}from"./file-spreadsheet-BT8Pbvpx.js";import{K as P}from"./KPICard-Dq9txBsB.js";import{H as Ne}from"./history-Ba7qPAwP.js";import{P as ye}from"./pen-line-DW-_VzYb.js";import{C as ve}from"./clock-Dh0pZaEI.js";import{D as V}from"./download-DKlEkoFw.js";import{U as Se}from"./upload-CyUrlT-d.js";import{P as Ce}from"./plus-DzCobvzz.js";const De=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],B=me("archive",De);function Ie(t){if(!t)return 0;const s=String(t).match(/([\d.]+)/),r=s?parseFloat(s[1]):0;return r<0?0:r}function Ee(t){return t?String(t).padStart(8,"0"):""}function _e(t){if(!t)return"";const s=String(t).trim();if(!/[eE][+-]?\d+/.test(s))return s;try{return Number(s).toLocaleString("fullwide",{useGrouping:!1})}catch{return s}}function v(t){if(!t)return"";const s=String(t).trim();return/[eE][+-]?\d+/.test(s)?_e(s):s}function Pe(t){const s=v(t.Id||t.B||""),r=v(t.Telefono||t.R||""),i=v(t.Movil||t.U||""),n=v(t.Cedula||t.Z||"");let l=v(t.Codigo||t.AC||"");return l=l.replace(/\D/g,""),l!==""&&(l=l.replace(/^0+/,"")||"0"),{id:s,nombre:W(t.Nombre||t.C||"").nombre,estado_cuenta:W(t.Nombre||t.C||"").estado,mac:t.Mac||t.D||"",ip:t.Ip||t.E||"",ip_receptor:t["IP Receptor"]||t.F||"",ultimo_vencimiento:t["Ultimo vencimiento"]||t.G||"",ultimo_pago:t["Ultimo pago"]||t.H||"",tipo_estrato:t["Tipo estrato"]||t.I||"",direccion:t["Dirección Principal"]||t["Direccion Principal"]||t.K||"",fecha_suspendido:t["Fecha suspendido"]||t.L||"",direccion_servicio:t["Dirección Servicio"]||t["Direccion Servicio"]||t.N||"",dia_pago:t["Dia pago"]||t.O||"",deuda_raw:t["Deuda actual"]||t.P||"",deuda_meses:q(t["Deuda actual"]||t.P).meses,deuda_monto:q(t["Deuda actual"]||t.P).monto,notas_tecnicas:H(t.Correo||t.Q)?"":t.Correo||t.Q||"",email:H(t.Correo||t.Q)?t.Correo||t.Q:"",telefono:r,plan:ke(t.Plan||t.S||""),proximo_pago:t["Proximo pago"]||t.T||"",movil_1:G(i).movil1,movil_2:G(i).movil2,saldo:t.Saldo||t.V||"S/. 0.00",nodo_router:t.Router||t.X||"",nodo:t.Router||t.X||"",fecha_instalacion:t.Instalado||t.Y||"",dni:Ee(n),user_ppp:t["User PPP/Hotspot"]||t.AA||"",codigo:l,total_cobrar:t["Total cobrar"]||t.AF||"",precio:Ie(t["Total cobrar"]||t.AF),zona:t.Zona||t.AG||"",status:t.Status||t.AH||"",servicios_adicionales:Te(t["Servicios personalizados"]||t.AI),tecnologia:Oe(t.Router||t.X,t.Plan||t.S),estado_servicio:Re(t.Plan||t.S,t.Nombre||t.C)}}function W(t){if(!t)return{nombre:"",estado:"DESCONOCIDO"};const s=String(t).trim(),r=s.match(/^(.+?)\s{2,}(ACTIVO|SUSPENDIDO)\s*$/);return r?{nombre:r[1].trim(),estado:r[2]}:s.endsWith("ACTIVO")?{nombre:s.replace(/\s*ACTIVO$/,"").trim(),estado:"ACTIVO"}:s.endsWith("SUSPENDIDO")?{nombre:s.replace(/\s*SUSPENDIDO$/,"").trim(),estado:"SUSPENDIDO"}:{nombre:s,estado:"ACTIVO"}}function H(t){return t&&String(t).includes("@")}function G(t){if(!t)return{movil1:"",movil2:""};let s=v(t);if(s=s.replace(/\s/g,""),s.includes(",")){const r=s.split(",").filter(Boolean);return{movil1:r[0]||"",movil2:r[1]||""}}return s.length>12?{movil1:s.substring(0,9),movil2:s.substring(9)}:{movil1:s,movil2:""}}function ke(t){return t?t.toUpperCase()==="CORTE POR DEUDA"?"CORTE POR DEUDA (Sin plan asignado)":t:""}function q(t){if(!t)return{meses:0,monto:0};const s=String(t).match(/(\d+)\s*S\/\.\s*([\d.]+)/);return s?{meses:parseInt(s[1]),monto:parseFloat(s[2])}:{meses:0,monto:0}}function Oe(t,s){const r=String(t||"").toUpperCase(),i=String(s||"").toUpperCase();return["OLT","FIBRA","GPON","DIXON","HUWEI"].some(n=>r.includes(n))||i.includes("FIBRA")||i.includes("GPON")?"Fibra Óptica":["ND1","ND2","ND3","/1100","/4011","ORCHALL"].some(n=>r.includes(n))||i.includes("ANTENA")?"Radio Enlace":"No Determinado"}function Re(t,s){return String(t).toUpperCase()==="CORTE POR DEUDA"?"Cortado":String(s).includes("SUSPENDIDO")?"Suspendido":"Activo"}function Te(t){if(!t)return[];const s=/([^(]+)\(S\/\.\s*([\d.]+)\)/g,r=[];let i;for(;(i=s.exec(String(t)))!==null;)r.push({tipo:i[1].trim(),precio:parseFloat(i[2])});return r}function ze(t,s){const r=[],i=[{key:"status",label:"Estado Conexión"},{key:"estado_cuenta",label:"Estado Cuenta"},{key:"deuda_monto",label:"Deuda",format:n=>`S/. ${n}`},{key:"plan",label:"Plan"},{key:"precio",label:"Precio",format:n=>`S/. ${n}`},{key:"ip",label:"IP"},{key:"nodo_router",label:"Nodo/Router"},{key:"movil_1",label:"Móvil"},{key:"ultimo_pago",label:"Último Pago"}];for(const n of i){const l=t[n.key],c=s[n.key];if(String(l)!==String(c)){const d=n.format||(j=>j);r.push({field:n.label,old:d(l),new:d(c)})}}return r}function Ae({onDataLoaded:t,loading:s}){const r=f.useRef(null),i=c=>{if(!c)return;const d=new FileReader;d.onload=j=>{const S=je(j.target.result,{type:"array",cellText:!1,cellDates:!1,raw:!1}),k=S.Sheets[S.SheetNames[0]],g=y.sheet_to_json(k,{range:1,defval:"",raw:!1});t(g,c.name)},d.readAsArrayBuffer(c)},n=c=>{c.preventDefault(),c.stopPropagation();const d=c.dataTransfer.files[0];d&&(d.name.endsWith(".xlsx")||d.name.endsWith(".xls"))&&i(d)},l=c=>{c.preventDefault(),c.stopPropagation()};return e.jsxs("div",{onDrop:n,onDragOver:l,onClick:()=>r.current?.click(),className:"bg-bg-card rounded-2xl p-10 border-2 border-dashed border-border text-center cursor-pointer transition-colors hover:border-accent-blue/50 group",children:[e.jsx("input",{ref:r,type:"file",accept:".xlsx,.xls",className:"hidden",onChange:c=>i(c.target.files[0])}),e.jsx("div",{className:"mb-6 text-accent-blue group-hover:scale-110 transition-transform inline-block",children:e.jsx(xe,{size:48,strokeWidth:1.5})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:s?"Procesando archivo...":"Arrastra tu archivo Excel aquí"}),e.jsx("p",{className:"text-text-muted text-[13px] mb-6 max-w-[400px] mx-auto",children:"El sistema aplicará automáticamente las 9 reglas de limpieza: separación de nombres, corrección de móviles, detección de tecnología, parseo de deuda y más."}),e.jsxs("div",{className:"inline-flex items-center gap-2 py-2.5 px-5 rounded-xl bg-accent-blue text-white text-sm font-semibold",children:[e.jsx(z,{size:16}),"Seleccionar archivo Excel"]}),e.jsx("p",{className:"mt-4 text-[11px] text-text-muted",children:'Soporta .xlsx, .xls — Formato estándar "Lista de Usuarios" del ISP externo'})]})}function Fe({stats:t,changes:s,onConfirm:r,onCancel:i}){return e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsx(P,{title:"Registros Leídos",value:t.total,icon:e.jsx(pe,{size:20}),color:"#6b7280"}),e.jsx(P,{title:"Nuevos Clientes",value:t.new,icon:e.jsx(ue,{size:20}),color:"#10b981"}),e.jsx(P,{title:"Modificados",value:t.modified,icon:e.jsx(J,{size:20}),color:"#f59e0b"}),e.jsx(P,{title:"Sin Cambios",value:t.unchanged,icon:e.jsx(Q,{size:20}),color:"#3b82f6"})]}),e.jsxs("div",{className:"bg-bg-card rounded-2xl border border-border overflow-hidden",children:[e.jsxs("div",{className:"py-4 px-6 border-b border-border flex justify-between items-center",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Detalle de Cambios Detectados"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:i,className:"py-2 px-4 rounded-lg bg-bg-secondary border border-border text-text-secondary text-xs font-semibold cursor-pointer hover:border-accent-red transition-colors",children:"Cancelar"}),e.jsxs("button",{onClick:r,className:"py-2 px-4 rounded-lg bg-accent-green border-none text-white text-xs font-semibold cursor-pointer flex items-center gap-1.5 hover:opacity-90 transition-opacity",children:[e.jsx(X,{size:14}),"Confirmar Importación"]})]})]}),e.jsx("div",{className:"max-h-[400px] overflow-y-auto",children:e.jsxs("table",{className:"w-full border-collapse text-[13px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-bg-secondary text-left sticky top-0",children:[e.jsx("th",{className:"py-3 px-6 w-20 text-[11px] text-text-secondary uppercase",children:"Tipo"}),e.jsx("th",{className:"py-3 px-6 text-[11px] text-text-secondary uppercase",children:"Cliente"}),e.jsx("th",{className:"py-3 px-6 text-[11px] text-text-secondary uppercase",children:"Detalle del Cambio"})]})}),e.jsxs("tbody",{children:[s.map((n,l)=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"py-3 px-6",children:e.jsx("span",{className:`py-1 px-2 rounded text-[11px] font-bold
                      ${n.type==="NEW"?"bg-accent-green/20 text-accent-green":"bg-accent-yellow/20 text-accent-yellow"}`,children:n.type==="NEW"?"NUEVO":"MODIF"})}),e.jsxs("td",{className:"py-3 px-6",children:[e.jsx("div",{className:"font-medium",children:n.type==="NEW"?n.data.nombre:n.nombre}),e.jsxs("div",{className:"text-[11px] text-text-muted",children:["ID: ",n.type==="NEW"?n.data.id:n.id]})]}),e.jsx("td",{className:"py-3 px-6",children:n.type==="NEW"?e.jsx("span",{className:"text-text-muted",children:"Registro completo nuevo"}):e.jsx("div",{className:"flex flex-col gap-1",children:n.diffs.map((c,d)=>e.jsxs("div",{className:"text-xs",children:[e.jsxs("span",{className:"text-text-secondary",children:[c.field,":"]})," ",e.jsx("span",{className:"line-through text-text-muted",children:c.old})," ","→ ",e.jsx("span",{className:"text-text-primary font-medium",children:c.new})]},d))})})]},l)),s.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"3",className:"py-6 text-center text-text-muted",children:"No se detectaron cambios significativos entre la data actual y el archivo importado."})})]})]})})]})]})}function Le({current:t,total:s,stage:r}){const i=s>0?Math.round(t/s*100):0,n={reading:"Leyendo archivo Excel...",transforming:"Aplicando reglas ETL...",comparing:"Comparando con datos actuales...",done:"Procesamiento completado"};return e.jsxs("div",{className:"bg-bg-card rounded-2xl border border-border p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(be,{size:20,className:"text-accent-blue animate-spin"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:n[r]||"Procesando..."}),e.jsxs("p",{className:"text-[11px] text-text-muted",children:[t," de ",s," registros"]})]}),e.jsxs("span",{className:"ml-auto text-lg font-bold text-accent-blue font-mono",children:[i,"%"]})]}),e.jsx("div",{className:"w-full h-2.5 bg-bg-secondary rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-accent-blue to-accent-purple rounded-full transition-all duration-300",style:{width:`${i}%`}})})]})}function Me(){const t=p(s=>s.importHistory);return t.length===0?null:e.jsxs("div",{className:"bg-bg-card rounded-2xl border border-border p-5 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ne,{size:18,className:"text-accent-blue"}),e.jsx("h3",{className:"text-sm font-semibold",children:"Historial de Importaciones"}),e.jsxs("span",{className:"ml-auto text-[11px] text-text-muted",children:[t.length," registros"]})]}),e.jsx("div",{className:"max-h-[200px] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-[12px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-[10px] text-text-muted uppercase border-b border-border",children:[e.jsx("th",{className:"py-2 px-3",children:"ID"}),e.jsx("th",{className:"py-2 px-3",children:"Fecha"}),e.jsx("th",{className:"py-2 px-3",children:"Archivo"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Total"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Nuevos"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Modif."}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Sin cambios"}),e.jsx("th",{className:"py-2 px-3",children:"Modo"})]})}),e.jsx("tbody",{children:t.map(s=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"py-2 px-3 font-mono text-text-muted",children:s.id}),e.jsx("td",{className:"py-2 px-3 text-text-secondary",children:new Date(s.fecha).toLocaleString("es-PE",{dateStyle:"short",timeStyle:"short"})}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(z,{size:12,className:"text-accent-green"}),e.jsx("span",{className:"font-medium truncate max-w-[150px]",children:s.fileName})]})}),e.jsx("td",{className:"py-2 px-3 text-center font-mono",children:s.total}),e.jsx("td",{className:"py-2 px-3 text-center font-mono text-accent-green",children:s.new}),e.jsx("td",{className:"py-2 px-3 text-center font-mono text-accent-yellow",children:s.modified}),e.jsx("td",{className:"py-2 px-3 text-center font-mono text-text-muted",children:s.unchanged}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("span",{className:"py-0.5 px-2 rounded text-[10px] font-semibold bg-accent-blue/15 text-accent-blue",children:s.mode||"Completa"})})]},s.id))})]})})]})}const w=[{key:"separateNameStatus",label:"Separar Nombre y Estado",desc:"Extrae el estado (ACTIVO/SUSPENDIDO) del campo Nombre"},{key:"classifyEmail",label:"Clasificar Email",desc:"Detecta si el campo Correo contiene email real o notas técnicas"},{key:"splitMobile",label:"Separar Móviles",desc:"Divide números múltiples en móvil principal y secundario"},{key:"parseDebt",label:"Parsear Deuda",desc:'Extrae meses y monto de deuda del campo "Deuda actual"'},{key:"parsePrices",label:"Parsear Precios",desc:'Convierte "S/. 65.00" → número 65'},{key:"inferTechnology",label:"Inferir Tecnología",desc:"Detecta Radio Enlace vs Fibra Óptica desde el nodo/router"},{key:"separateTV",label:"Separar TV Cable",desc:"Extrae servicio de TV Cable y cantidad de decos del plan"},{key:"normalizeCortePorDeuda",label:"Normalizar Corte",desc:'Detecta "Cortado por deuda" desde la combinación de campos'},{key:"formatDNI",label:"Formatear DNI",desc:"Limpia y normaliza el campo Cédula/DNI"}];function Ue(){const t=p(n=>n.cleaningOptions),s=p(n=>n.setCleaningOptions),r=n=>{s({...t,[n]:!t[n]})},i=Object.values(t).filter(Boolean).length;return e.jsxs("div",{className:"bg-bg-card rounded-2xl border border-border p-5 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{size:18,className:"text-accent-purple"}),e.jsx("h3",{className:"text-sm font-semibold",children:"Reglas de Limpieza ETL"})]}),e.jsxs("span",{className:"text-[11px] text-text-muted bg-bg-secondary py-1 px-2.5 rounded-lg",children:[i,"/",w.length," activas"]})]}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:w.map(n=>e.jsxs("label",{className:`flex items-start gap-2.5 p-3 rounded-xl border cursor-pointer transition-all
              ${t[n.key]?"border-accent-purple/30 bg-accent-purple/5":"border-border bg-bg-secondary hover:border-border"}`,children:[e.jsx("input",{type:"checkbox",checked:t[n.key],onChange:()=>r(n.key),className:"mt-0.5 accent-accent-purple"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold",children:n.label}),e.jsx("p",{className:"text-[10px] text-text-muted mt-0.5",children:n.desc})]})]},n.key))})]})}function $e({items:t,onFix:s}){return!t||t.length===0?null:e.jsxs("div",{className:"bg-bg-card rounded-2xl border border-accent-yellow/30 p-5 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(he,{size:18,className:"text-accent-yellow"}),e.jsx("h3",{className:"text-sm font-semibold",children:"Revisión Manual Requerida"}),e.jsxs("span",{className:"ml-auto text-[11px] text-accent-yellow font-semibold bg-accent-yellow/10 py-1 px-2.5 rounded-lg",children:[t.length," registros"]})]}),e.jsx("p",{className:"text-[11px] text-text-muted mb-3",children:"Estos registros tienen datos que no pudieron ser procesados automáticamente por las reglas ETL."}),e.jsx("div",{className:"max-h-[250px] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-[12px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-[10px] text-text-muted uppercase border-b border-border sticky top-0 bg-bg-card",children:[e.jsx("th",{className:"py-2 px-3",children:"ID"}),e.jsx("th",{className:"py-2 px-3",children:"Nombre"}),e.jsx("th",{className:"py-2 px-3",children:"Problema"}),e.jsx("th",{className:"py-2 px-3",children:"Campo"}),e.jsx("th",{className:"py-2 px-3",children:"Valor Original"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Acción"})]})}),e.jsx("tbody",{children:t.map((r,i)=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"py-2 px-3 font-mono text-text-muted text-[11px]",children:r.id}),e.jsx("td",{className:"py-2 px-3 font-medium",children:r.nombre}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("span",{className:`py-0.5 px-2 rounded text-[10px] font-semibold
                    ${r.tipo==="movil"?"bg-accent-red/15 text-accent-red":r.tipo==="tecnologia"?"bg-accent-yellow/15 text-accent-yellow":"bg-accent-blue/15 text-accent-blue"}`,children:r.tipo==="movil"?"Móvil inválido":r.tipo==="tecnologia"?"Tecnología no detectada":r.tipo==="deuda"?"Deuda no parseable":r.tipo})}),e.jsx("td",{className:"py-2 px-3 text-text-secondary",children:r.campo}),e.jsx("td",{className:"py-2 px-3 font-mono text-[11px] text-accent-red",children:r.valorOriginal}),e.jsx("td",{className:"py-2 px-3 text-center",children:s&&e.jsx("button",{onClick:()=>s(r),className:"p-1 rounded-lg bg-bg-secondary border border-border text-text-secondary cursor-pointer hover:border-accent-blue hover:text-accent-blue transition-colors",children:e.jsx(ye,{size:12})})})]},i))})]})})]})}function Ve(){const t=p(l=>l.lastImport),s=p(l=>l.dataSource),r=p(l=>l.clients),n=(()=>{if(!t)return{icon:e.jsx(ge,{size:16}),label:"Sin sincronizar",color:"text-text-muted",bg:"bg-bg-secondary",detail:"No se ha realizado ninguna importación"};const l=new Date(t.date),c=(Date.now()-l.getTime())/(1e3*60*60);return c<1?{icon:e.jsx(X,{size:16}),label:"Sincronizado",color:"text-accent-green",bg:"bg-accent-green/10",detail:`Hace ${Math.round(c*60)} minutos`}:c<24?{icon:e.jsx(ve,{size:16}),label:"Actualizado hoy",color:"text-accent-blue",bg:"bg-accent-blue/10",detail:l.toLocaleTimeString("es-PE",{hour:"2-digit",minute:"2-digit"})}:{icon:e.jsx(K,{size:16}),label:"Desactualizado",color:"text-accent-yellow",bg:"bg-accent-yellow/10",detail:l.toLocaleDateString("es-PE")}})();return e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-xl ${n.bg} border border-border mb-6`,children:[e.jsx("div",{className:n.color,children:n.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-xs font-semibold ${n.color}`,children:n.label}),e.jsx("p",{className:"text-[10px] text-text-muted",children:n.detail})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-[10px] text-text-muted",children:["Fuente: ",e.jsx("span",{className:"font-semibold text-text-secondary",children:s==="excel"?"Excel":"Demo"})]}),e.jsxs("p",{className:"text-[10px] text-text-muted",children:[r.length," clientes cargados"]})]}),t&&e.jsxs("div",{className:"text-right border-l border-border pl-3",children:[e.jsxs("p",{className:"text-[10px] text-text-muted",children:["Último: ",e.jsx("span",{className:"font-mono",children:t.fileName})]}),e.jsxs("p",{className:"text-[10px] text-text-muted",children:[e.jsxs("span",{className:"text-accent-green",children:[t.new," nuevos"]})," · ",e.jsxs("span",{className:"text-accent-yellow",children:[t.modified," modif."]})]})]})]})}function Ze(){const t=p(o=>o.clients),s=p(o=>o.importClients),r=p(o=>o.setLastImport),i=p(o=>o.addImportRecord),n=p(o=>o.cleaningOptions),l=p(o=>o.restoreSystem),c=p(o=>o.factoryReset),[d,j]=f.useState("upload"),[S,k]=f.useState(""),[g,Z]=f.useState({new:0,modified:0,unchanged:0,total:0}),[A,Y]=f.useState([]),[E,ee]=f.useState([]),[F,te]=f.useState([]),[O,C]=f.useState({current:0,total:0,stage:"reading"}),[N,se]=f.useState("inteligente"),[R,ae]=f.useState(!1),L=f.useRef(null),oe=(o,u)=>{k(u),j("processing"),C({current:0,total:o.length,stage:"reading"}),setTimeout(()=>{C(m=>({...m,stage:"transforming"}));const x=[],a=o.map((m,I)=>{I%50===0&&C(_=>({..._,current:I,stage:"transforming"}));const h=Pe(m);if(n.splitMobile){const _=h.movil_1?.replace(/\D/g,"")||"";_.length>0&&_.length<9&&x.push({id:h.id,nombre:h.nombre,tipo:"movil",campo:"Móvil",valorOriginal:h.movil_1})}return n.inferTechnology&&h.tecnologia==="No determinada"&&x.push({id:h.id,nombre:h.nombre,tipo:"tecnologia",campo:"Tecnología",valorOriginal:h.nodo_router||"—"}),h});C({current:o.length,total:o.length,stage:"comparing"}),te(x);const b=[],D=[];let T=0;const de=new Map(t.map(m=>[m.id,m]));a.forEach(m=>{const I=de.get(m.id);if(!I)b.push(m);else if(N!=="nuevos"){const h=ze(I,m);h.length>0?D.push({id:m.id,nombre:m.nombre,diffs:h,newData:m}):T++}else T++}),Z({new:b.length,modified:D.length,unchanged:T,total:a.length}),Y([...b.map(m=>({type:"NEW",data:m})),...D.map(m=>({type:"MOD",...m}))]),ee(a),C({current:o.length,total:o.length,stage:"done"}),setTimeout(()=>j("preview"),500)},100)},ne=()=>{let o;if(N==="completa")o=E;else if(N==="nuevos"){const x=new Set(A.filter(a=>a.type==="NEW").map(a=>a.data.id));o=[...t,...E.filter(a=>x.has(a.id))]}else{const x=new Map(E.map(a=>[a.id,a]));o=t.map(a=>x.get(a.id)||a),E.forEach(a=>{t.find(b=>b.id===a.id)||o.push(a)})}s(o);const u={date:new Date().toISOString(),fileName:S,total:g.total,new:g.new,modified:g.modified,unchanged:g.unchanged};r(u),i({...u,mode:N}),j("finished")},M=()=>{const o=t.map(a=>({Id:a.id,Nombre:`${a.nombre}  ${a.estado_cuenta}`,Mac:a.mac,Ip:a.ip,"IP Receptor":a.ip_receptor,"Ultimo pago":a.ultimo_pago,"Tipo estrato":a.tipo_estrato,"Dirección Principal":a.direccion,"Dirección Servicio":a.direccion_servicio,"Dia pago":a.dia_pago,"Deuda actual":a.deuda_monto>0?`${a.deuda_meses} S/. ${a.deuda_monto.toFixed(2)}`:"",Correo:a.email||a.notas_tecnicas,Plan:a.plan,"Proximo pago":a.proximo_pago,Movil:a.movil_2?`${a.movil_1}${a.movil_2}`:a.movil_1,Saldo:a.saldo,Router:a.nodo_router,Instalado:a.fecha_instalacion,Cedula:a.dni,"User PPP/Hotspot":a.user_ppp,Codigo:a.codigo,"Total cobrar":`S/. ${a.precio.toFixed(2)}`,Zona:a.zona,Status:a.status})),u=y.json_to_sheet(o),x=y.book_new();y.book_append_sheet(x,u,"Sheet1"),U(x,"Lista_de_Usuarios_Actualizada.xlsx")},re=()=>{const o=p.getState(),u=y.book_new();[{name:"Clientes",data:o.clients},{name:"Tickets",data:o.tickets},{name:"Averias",data:o.averias},{name:"Visitas",data:o.visitas},{name:"Tecnicos",data:o.tecnicos},{name:"Equipos",data:o.equipos},{name:"Instalaciones",data:o.instalaciones},{name:"PostVenta",data:o.postVenta},{name:"SoporteRemoto",data:o.sesionesRemoto},{name:"Derivaciones",data:o.derivaciones},{name:"HistorialImport",data:o.importHistory},{name:"LogsWhatsApp",data:o.whatsappLogs},{name:"Plantillas",data:o.templates}].forEach(({name:a,data:b})=>{if(b&&Array.isArray(b)&&b.length>0){const D=y.json_to_sheet(b);y.book_append_sheet(u,D,a)}}),U(u,`ISP_Backup_Completo_${new Date().toISOString().slice(0,10)}.xlsx`)},ie=()=>{const u={...p.getState()},x="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(u,null,2)),a=document.createElement("a");a.setAttribute("href",x),a.setAttribute("download",`ISP_System_Backup_${new Date().toISOString().slice(0,10)}.json`),document.body.appendChild(a),a.click(),a.remove()},le=o=>{const u=o.target.files[0];if(!u)return;const x=new FileReader;x.onload=async a=>{try{const b=JSON.parse(a.target.result);await l(b),alert("Sistema restaurado correctamente. La página se recargará para aplicar los cambios."),window.location.reload()}catch(b){alert("Error al leer el archivo de respaldo: "+b.message)}},x.readAsText(u),o.target.value=""},ce=()=>{window.confirm(`⚠️ ¿Estás seguro de realizar un FACTORY RESET?

Esta acción eliminará TODOS los datos guardados en la base de datos local (IndexedDB) y recargará el sistema con los datos iniciales del archivo db.json.

Se recomienda exportar un backup antes.`)&&c()};return d==="finished"?e.jsxs("div",{className:"p-10 text-center h-full flex flex-col items-center justify-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-accent-green text-white flex items-center justify-center mb-6",children:e.jsx(Q,{size:28})}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Importación Exitosa"}),e.jsxs("p",{className:"text-text-secondary mb-2",children:["Se procesaron ",e.jsx("span",{className:"text-text-primary font-semibold",children:g.total})," registros del archivo ",e.jsx("span",{className:"font-mono text-xs text-accent-blue",children:S})]}),e.jsxs("p",{className:"text-text-muted text-sm mb-2",children:[g.new," nuevos · ",g.modified," modificados · ",g.unchanged," sin cambios"]}),e.jsxs("p",{className:"text-[11px] text-text-muted mb-6",children:["Modo: ",e.jsx("span",{className:"font-semibold",children:N==="completa"?"Reemplazo completo":N==="nuevos"?"Solo nuevos":"Sincronización inteligente"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>j("upload"),className:"py-2.5 px-6 rounded-lg bg-bg-secondary border border-border text-text-primary cursor-pointer text-sm",children:"Nueva importación"}),e.jsxs("button",{onClick:M,className:"py-2.5 px-6 rounded-lg bg-accent-blue border-none text-white cursor-pointer text-sm font-semibold flex items-center gap-2",children:[e.jsx(V,{size:16}),"Exportar Excel"]})]})]}):e.jsxs("div",{className:"animate-fade p-4 sm:p-6 sm:px-8 h-full overflow-y-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl sm:text-[26px] font-bold",children:"Importar Datos"}),e.jsx("p",{className:"text-text-secondary text-sm",children:"Sincronización desde Excel fuente (ISP Externo)"})]}),e.jsx("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:t.length>0&&e.jsxs("button",{onClick:M,className:"py-2 px-4 rounded-lg bg-bg-card border border-border text-text-secondary text-xs font-semibold cursor-pointer flex items-center gap-1.5 hover:border-accent-blue transition-colors",children:[e.jsx(V,{size:14}),"Exportar datos"]})})]}),e.jsx(Ve,{}),d==="upload"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-bg-card rounded-2xl border border-border p-5 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(B,{size:18,className:"text-accent-green"}),e.jsx("h3",{className:"text-sm font-semibold",children:"Copia de Seguridad (Backup)"})]}),e.jsx("p",{className:"text-[11px] text-text-muted mb-4",children:"Descarga una copia completa de toda la información del sistema (Clientes, Tickets, Visitas, etc.) para evitar pérdida de datos."}),e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[e.jsxs("button",{onClick:re,className:"flex items-center gap-2 py-2.5 px-4 rounded-lg bg-bg-secondary border border-border text-text-primary text-xs font-semibold cursor-pointer hover:border-accent-green transition-colors",children:[e.jsx(z,{size:16,className:"text-accent-green"}),"Exportar Todo (Excel)"]}),e.jsxs("button",{onClick:ie,className:"flex items-center gap-2 py-2.5 px-4 rounded-lg bg-bg-secondary border border-border text-text-primary text-xs font-semibold cursor-pointer hover:border-accent-blue transition-colors",children:[e.jsx(B,{size:16,className:"text-accent-blue"}),"Exportar General"]}),e.jsx("input",{type:"file",ref:L,accept:".json",onChange:le,className:"hidden"}),e.jsxs("button",{onClick:()=>L.current?.click(),className:"flex items-center gap-2 py-2.5 px-4 rounded-lg bg-bg-secondary border border-border text-text-primary text-xs font-semibold cursor-pointer hover:border-accent-purple transition-colors",children:[e.jsx(Se,{size:16,className:"text-accent-purple"}),"Importar General"]}),e.jsxs("button",{onClick:ce,className:"flex items-center gap-2 py-2.5 px-4 rounded-lg bg-accent-red/10 border border-accent-red/30 text-accent-red text-xs font-semibold cursor-pointer hover:bg-accent-red/20 transition-colors ml-auto",children:[e.jsx(fe,{size:16}),"Factory Reset"]})]})]}),e.jsxs("div",{className:"bg-bg-card rounded-2xl border border-border p-5 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx($,{size:18,className:"text-accent-blue"}),e.jsx("h3",{className:"text-sm font-semibold",children:"Modo de Importación"})]}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{value:"inteligente",label:"Inteligente",desc:"Compara e integra nuevos y modificados sin perder datos existentes",icon:e.jsx(K,{size:16})},{value:"completa",label:"Reemplazo Completo",desc:"Reemplaza toda la base de datos con el archivo importado",icon:e.jsx($,{size:16})},{value:"nuevos",label:"Solo Nuevos",desc:"Agrega únicamente registros que no existen en el sistema",icon:e.jsx(Ce,{size:16})}].map(o=>e.jsxs("label",{className:`flex items-start gap-3 p-4 rounded-xl border cursor-pointer transition-all
                    ${N===o.value?"border-accent-blue bg-accent-blue/5":"border-border bg-bg-secondary hover:border-border"}`,children:[e.jsx("input",{type:"radio",name:"importMode",value:o.value,checked:N===o.value,onChange:()=>se(o.value),className:"mt-1 accent-accent-blue"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-accent-blue",children:o.icon}),e.jsx("p",{className:"text-sm font-semibold",children:o.label})]}),e.jsx("p",{className:"text-[11px] text-text-muted mt-1",children:o.desc})]})]},o.value))})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>ae(!R),className:"text-xs text-accent-purple font-semibold cursor-pointer bg-transparent border-none flex items-center gap-1 hover:opacity-80",children:[e.jsx("span",{children:R?"▾":"▸"}),"Configurar reglas de limpieza ETL (",Object.values(n).filter(Boolean).length,"/9 activas)"]})}),R&&e.jsx(Ue,{}),e.jsx(Ae,{onDataLoaded:oe,loading:!1}),e.jsx("div",{className:"mt-6",children:e.jsx(Me,{})})]}),d==="processing"&&e.jsx(Le,{current:O.current,total:O.total,stage:O.stage}),d==="preview"&&e.jsxs(e.Fragment,{children:[F.length>0&&e.jsx($e,{items:F}),e.jsx(Fe,{stats:g,changes:A,onConfirm:ne,onCancel:()=>j("upload")})]})]})}export{Ze as default};
